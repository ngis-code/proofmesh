version: "3.9"

services:
  cockroachdb:
    image: cockroachdb/cockroach:v24.1.0
    command: start-single-node --insecure --http-addr=:8080 --listen-addr=:26257
    ports:
      - "26257:26257"
      - "8080:8080"
    volumes:
      - cockroach-data:/cockroach/cockroach-data
    healthcheck:
      test: ["CMD", "cockroach", "node", "status", "--insecure"]
      interval: 10s
      timeout: 5s
      retries: 5

  mqtt:
    image: eclipse-mosquitto:2.0
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  api:
    build:
      context: ..
      dockerfile: apps/api/Dockerfile
    depends_on:
      cockroachdb:
        condition: service_healthy
      mqtt:
        condition: service_started
    env_file:
      - ../.env
    environment:
      - DB_HOST=cockroachdb
      - DB_PORT=26257
      # Use Cockroach's defaultdb by default so a brand-new cluster works
      # without manual database creation. Override DB_NAME via .env if you
      # want a custom database name in production.
      - DB_NAME=defaultdb
      - MQTT_URL=mqtt://mqtt:1883
      - VERIFY_TIMEOUT_MS=1000
    ports:
      - "3000:3000"

  validator1:
    build:
      context: ..
      dockerfile: apps/validator/Dockerfile
    depends_on:
      mqtt:
        condition: service_started
    environment:
      - VALIDATOR_ID=landon
      - VALIDATOR_SECRET=landon
      - MQTT_URL=mqtt://mqtt:1883
      - API_BASE_URL=http://api:3000
      - SQLITE_PATH=/data/validator.db
    volumes:
      - validator1-data:/data

  web:
    build:
      context: ..
      dockerfile: apps/web/Dockerfile
    depends_on:
      api:
        condition: service_started
    ports:
      - "5173:5173"
    environment:
      - VITE_API_BASE_URL=http://localhost:3000

  n8n:
    image: n8nio/n8n:latest
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=false
      - N8N_HOST=localhost
      - N8N_PORT=5678

volumes:
  cockroach-data:
  validator1-data:


